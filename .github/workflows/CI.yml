on:
  workflow_dispatch: {}
  schedule:
  - cron: "0 14 * * *"

jobs:
  build-tauri-macos:
    runs-on: macos-11
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-node@v2
      with: { node-version: '16', cache: 'npm' }
    - uses: actions-rs/toolchain@v1
      with: { profile: minimal, toolchain: nightly, override: true }
    - uses: Swatinem/rust-cache@v1
      with: { cache-on-failure: true }
    - run: |-
        npm install --global npm@7
        npm install
    - uses: ./.github/workflows/setup-faust
      with: { version: 2.33.1 }
    - run: |-
        cargo install tauri-cli 1.0.0-beta.7
        cargo tauri build
      env:
        NODE_OPTIONS: '--max_old_space_size=6000' # FIXME(https://github.com/vitejs/vite/issues/4162)
    - uses: actions/upload-artifact@v2
      with: { name: Typebeat.dmg, path: target/release/bundle/dmg/Typebeat*.dmg }

  build-tauri-windows:
    runs-on: windows-2019
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-node@v2
      with: { node-version: '16', cache: 'npm' }
    - uses: actions-rs/toolchain@v1
      with: { profile: minimal, toolchain: nightly, override: true }
    - uses: Swatinem/rust-cache@v1
      with: { cache-on-failure: true }
    - run: |-
        npm install --global npm@7
        npm install
    - uses: ./.github/workflows/setup-faust
      with: { version: 2.33.1 }
    - run: |-
        cargo install tauri-cli 1.0.0-beta.7
        cargo tauri build
      env:
        NODE_OPTIONS: '--max_old_space_size=6000' # FIXME(https://github.com/vitejs/vite/issues/4162)
    - uses: actions/upload-artifact@v2
      with: { name: Typebeat.msi, path: target/release/bundle/msi/Typebeat*.msi }

  build-web:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-node@v2
      with: { node-version: '16', cache: 'npm' }
    - uses: actions-rs/toolchain@v1
      with: { profile: minimal, toolchain: nightly, override: true, target: wasm32-unknown-emscripten }
    - uses: Swatinem/rust-cache@v1
      with: { cache-on-failure: true }
    - uses: kofigumbs/setup-emsdk@master # FIXME(https://github.com/mymindstorm/setup-emsdk/pull/22)
      with: { version: '2.0.29', update-tags: true, actions-cache-folder: 'emsdk-cache' }
    - run: |-
        npm install --global npm@7 netlify-cli@6
        npm install
    - uses: ./.github/workflows/setup-faust
      with: { version: 2.33.1 }
    - env:
        FAUST_LIB_PATH: node_modules/.faust/libraries
        NODE_OPTIONS: '--max_old_space_size=6000' # FIXME(https://github.com/vitejs/vite/issues/4162)
      run: netlify build

  deploy-web:
    needs: [build-web, build-tauri-macos, build-tauri-windows]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-node@v2
      with: { node-version: '16', cache: 'npm' }
    - uses: actions/download-artifact@v2
      with: { name: Typebeat.dmg, path: src-web/client/dist/Typebeat.dmg }
    - uses: actions/download-artifact@v2
      with: { name: Typebeat.msi, path: src-web/client/dist/Typebeat.msi }
    - env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      run: netlify deploy --prod
