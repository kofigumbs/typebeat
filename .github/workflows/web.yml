on:
  workflow_dispatch: {}

env:
  EMSCRIPTEN_VERSION: 2.0.29
  NETLIFY_CLI_VERSION: 6
  NODE_VERSION: 16
  NPM_VERSION: 7
  WINDOWS_LLVM_VERSION: 12

  # FIXME(https://github.com/vitejs/vite/issues/4162)
  NODE_OPTIONS: '--max_old_space_size=6000'

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - uses: actions-rs/toolchain@v1
        with: { profile: minimal, toolchain: nightly, override: true, target: wasm32-unknown-emscripten }
      - uses: Swatinem/rust-cache@v1
        with: { cache-on-failure: true }
      - uses: kofigumbs/setup-emsdk@master # FIXME(https://github.com/mymindstorm/setup-emsdk/pull/22)
        with:
          version: ${{ env.EMSCRIPTEN_VERSION }}
          update-tags: true,
          actions-cache-folder: emsdk-cache
      - uses: kofigumbs/typebeat-faust@master
      - run: |-
          npm install --global "npm@$NPM_VERSION" "netlify-cli@$NETLIFY_CLI_VERSION"
          npm install
          netlify build --offline
      - run: netlify deploy --prod
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
