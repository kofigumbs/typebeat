on:
  workflow_dispatch: {}

env:
  LLVM_VERSION: 13
  NETLIFY_CLI_VERSION: 6
  NODE_VERSION: 16
  NPM_VERSION: 7
  TAURI_CLI_VERSION: 34509028627aa44c02ec38bf6c45e797c8ccfc69

  # FIXME(https://github.com/vitejs/vite/issues/4162)
  NODE_OPTIONS: '--max_old_space_size=6000'

jobs:
  main:
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - uses: actions-rs/toolchain@v1
        with: { profile: minimal, toolchain: nightly, override: true }
      - uses: Swatinem/rust-cache@v1
        with: { cache-on-failure: true }
      - uses: KyleMayes/install-llvm-action@v1
        with:
          version: ${{ env.LLVM_VERSION }}
      - uses: kofigumbs/typebeat-faust@master
      - run: |-
          npm install --global "npm@$NPM_VERSION" "netlify-cli@$NETLIFY_CLI_VERSION"
          npm install
          cargo install --git https://github.com/tauri-apps/tauri --rev $TAURI_CLI_VERSION tauri-cli
          cargo tauri build
      - run: netlify deploy --alias windows --dir target/release/bundle/msi
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
